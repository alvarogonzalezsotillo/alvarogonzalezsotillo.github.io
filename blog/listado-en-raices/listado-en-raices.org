#+TITLE:       Listado de fotos de Ra칤ces
#+AUTHOR:      츼lvaro Gonz치lez Sotillo
#+EMAIL:       alvarogonzalezsotillo@gmail.com
#+DATE:        2021-11-04
#+URI:         /blog/listado-en-raices
#+KEYWORDS:    javascript, raices
#+TAGS:        javascript, raices
#+LANGUAGE:    es
#+OPTIONS:     H:3 num:t \n:nil ::t |:t ^:nil -:nil f:t *:t <:t
#+options:     num:nil
#+DESCRIPTION:  El proyecto Raices es la herramienta de gesti칩n integrada de centros educativos de la Comunidad de Madrid. En la versi칩n actual, no permite crear una p치gina imprimible con las fotograf칤as y nombres de todos los alumnos de un grupo.



* El problema
 El proyecto Raices es la herramienta de gesti칩n integrada de centros educativos de la Comunidad de Madrid.  En la versi칩n actual, no permite crear una p치gina imprimible con las fotograf칤as y nombres de todos los alumnos de un grupo.

* La soluci칩n
A partir de la pantalla de *Faltas a d칤a completo en una unidad en un periodo* se puede generar una p치gina imprimible:

#+caption: Men칰 de Raices que muestra la p치gina requerida
[[file:menu-raices.png]]  
  
- En Firefox o Chrome, pulsar las teclas =CONTROL+MAY칔SCULAS+B=, hasta que se muestre la barra de marcadores (/bookmarks/).
- Despu칠s, arrastrar el recuadro de m치s abajo a la barra de marcadores
#+html: <center><a href="javascript:(function(){    try{        let inferior = window.frames['inferior'];        let principal = inferior.window.frames['principal'];        let cuerpo = principal.window.frames['cuerpo'];        let images = cuerpo.document.querySelectorAll('table.TableData \x3e tbody \x3e tr \x3e td \x3e img');        let names = cuerpo.document.querySelectorAll( 'table.TableData \x3e tbody \x3e tr \x3e td \x3e a');        let ciclo = cuerpo.document.querySelectorAll('select[name=X_OFERTAMATRIC] \x3e option[selected]')[0];        let title = ciclo.title;                let newWindow = window.open();        let newDocument = newWindow.document;        let header = '\x3chead\x3e\x3ctitle\x3e' + ciclo.title + '\x3c/title\x3e' +             '\x3cstyle\x3ebody{text-align: center;}'+                    'titulo{font-size: 20px;text-align: center;}'+                    'img{min-width: 70px;max-width: 70px;}' +                    'td{text-align: center;font-size: 12px;}' +             '\x3c/style\x3e\x3c/head\x3e';        newDocument.writeln(header);        newDocument.writeln(`\x3cbody\x3e`);        newDocument.writeln(`\x3ctitulo\x3e${ciclo.title}\x3c/titulo\x3e`);        newDocument.writeln('\x3ctable\x3e');        let column = 0;        const maxColumns = 5;        for( let i = 0 ; i+1 != images.length ; i++ ){            let image = images[i];            let name = names[i];            if( column == 0 ){                newDocument.writeln('\x3ctr\x3e');            }                        let html = '\x3ctd\x3e\x3cimg src=\''+image.src+'\'\x3e\x3cbr\x3e'+name.innerText+'\x3c/td\x3e';            newDocument.writeln(html);            column += 1;            if( column == 5 ){                newDocument.writeln('\x3ctr\x3e');                column = 0;            }                    }        newDocument.writeln('\x3c/table\x3e');        newDocument.writeln('\x3c/body\x3e');        window.setTimeout( ()=> newWindow.print(), 2000 );    }    catch(error){        console.log(error);        alert(            `Solo funciona en las p치ginas de:\n  'Faltas a d칤a completo en una unidad en un periodo'\n  'Faltas de asistencia de una unidad en una fecha'\n\nTambi칠n podr칤a ser que la versi칩n de raices es incompatible. Versiones nuevas en alvaro.gonzalezsotillo@educa.madrid.org`        );    }    })();" style="border-style:solid;background-color:yellow;">P치gina de fotograf칤as de grupo</a></center>
- Cuando se est칠 visualizando el listado de  *Faltas a d칤a completo en una unidad en un periodo*, pulsar el bot칩n creado usando el men칰 de /bookmarks/

#+caption: Invocar el /bookmark/ desde el men칰 en Firefox  
[[file:menu-bookmarks.png]]
* Explicaci칩n t칠cnica
Se puede acceder mediante javascript a la estructura de una p치gina web cargada en el navegador, y copiarla en una nueva p치gina. Puede ser un problema futuro si Raices cambia de versi칩n y modifica la estructura de sus p치ginas.

La ejecuci칩n del programa javascript se hace mediante un [[https://www.freecodecamp.org/news/what-are-bookmarklets/][bookmarklet]], que es un marcador que en vez de enviar el navegador a una p치gina, ejecuta un programa sobre la p치gina ya cargada.

El programa que se ejecuta es el siguiente. Se puede observar que, en 2021, la Comunidad de Madrid a칰n usa =framesets= 游땻
#+begin_src javascript
(function(){
    try{
        const inferior = window.frames['inferior'];

        const principal = inferior.window.frames['principal'];

        const cuerpo = principal.window.frames['cuerpo'];

        const images = cuerpo.document.querySelectorAll('table.TableData > tbody > tr > td > img');
        const names = cuerpo.document.querySelectorAll( 'table.TableData > tbody > tr > td > a');
        const ciclo = cuerpo.document.querySelectorAll('select[name=X_OFERTAMATRIC] > option[selected]')[0];
        const title = ciclo.title;

        
        const newWindow = window.open();
        const newDocument = newWindow.document;

        const header = '<head><title>' + ciclo.title + '</title>' +
             '<style>body{text-align: center;}'+
                    'titulo{font-size: 20px;text-align: center;}'+
                    'img{min-width: 70px;max-width: 70px;}' +
                    'td{text-align: center;font-size: 12px;}' +
             '</style></head>';

        newDocument.writeln(header);
        newDocument.writeln(`<body>`);
        newDocument.writeln(`<titulo>${ciclo.title}</titulo>`);
        newDocument.writeln('<table>');

        let column = 0;
        const maxColumns = 5;
        for( let i = 0 ; i+1 != images.length ; i++ ){
            const image = images[i];
            const name = names[i];

            if( column == 0 ){
                newDocument.writeln('<tr>');
            }
            
            const html = '<td><img src=\''+image.src+'\'><br>'+name.innerText+'</td>';
            newDocument.writeln(html);
            column += 1;

            if( column == 5 ){
                newDocument.writeln('<tr>');
                column = 0;
            }
            
        }
        newDocument.writeln('</table>');
        newDocument.writeln('</body>');
        window.setTimeout( newWindow.print.bind(newWindow), 2000 );

    }
    catch(error){
        console.log(error);
        alert(
            `Solo funciona en las p치ginas de:\n  'Faltas a d칤a completo en una unidad en un periodo'\n  'Faltas de asistencia de una unidad en una fecha'\n\nTambi칠n podr칤a ser que la versi칩n de raices es incompatible. Versiones nuevas en alvaro.gonzalezsotillo@educa.madrid.org`
        );
    }
    
})();
#+end_src

Para convertirlo en una sola l칤nea, y poder crear el bot칩n de m치s arriba, hay que escapar las comillas y los cierres de tag. Es necesario que el script no utilice, adem치s, ninguna comilla doble ni =<= ni =>= fuera de literales de cadena.

Utilizo el siguiente commando /bash/ en emacs con =shell-command-on-region=

#+begin_src bash
sed -e 's/</\\x3c/g' -e 's/>/\\x3e/g' | tr -d '\n'
#+end_src

* Actualizaci칩n 2022-09-21
Este a침o no soy tutor de ning칰n grupo, y parece que cuando no se es tutor cambian las p치ginas mostradas para las faltas. Este c칩digo funciona para no tutores:

#+begin_src javascript


(function(){
    try{
        let inferior = window.frames['inferior'];

        let principal = inferior.window.frames['principal'];

        let cuerpo = principal.window.frames['cuerpo'];

        let images = cuerpo.document.querySelectorAll('td.celdaTablaFormFila  img.imagenBordeVerde');
        let names = cuerpo.document.querySelectorAll( 'td.celdaTablaFormExt td.celdaTablaFormInt td.celdaTablaFormFila > table > tbody > tr:nth-child(2) > td[align=CENTER]');
        let ciclo = cuerpo.document.querySelectorAll('td[class=celdaFormTitulo]')[0];
        let title = ciclo.innerHTML.split('/')[1];

        console.log(names);
        
        let newWindow = window.open();
        let newDocument = newWindow.document;

        let header = '<head><title>' + title + '</title>' +
             '<style>body{text-align: center;}'+
                    'titulo{font-size: 20px;text-align: center;}'+
                    'img{min-width: 70px;max-width: 70px;}' +
                    'td{text-align: center;font-size: 12px;}' +
             '</style></head>';

        newDocument.writeln(header);
        newDocument.writeln(`<body>`);
        newDocument.writeln(`<titulo>${title}</titulo>`);
        newDocument.writeln('<table>');

        let column = 0;
        const maxColumns = 5;
        for( let i = 0 ; i+1 != images.length ; i++ ){
            let image = images[i];
            let name = names[i];

            if( column == 0 ){
                newDocument.writeln('<tr>');
            }
            
            let html = '<td><img src=\''+image.src+'\'><br>'+name.innerText+'</td>';
            newDocument.writeln(html);
            column += 1;

            if( column == 5 ){
                newDocument.writeln('<tr>');
                column = 0;
            }
            
        }
        newDocument.writeln('</table>');
        newDocument.writeln('</body>');
        window.setTimeout( ()=> newWindow.print(), 2000 );

    }
    catch(error){
        console.log(error);
        alert(
            `Solo funciona en las p치ginas de:\n  'Faltas de asistencia en una fecha y tramo'\n  \nTambi칠n podr칤a ser que la versi칩n de raices es incompatible. Versiones nuevas en alvaro.gonzalezsotillo@educa.madrid.org`
        );
    }
    
})();
#+end_src
