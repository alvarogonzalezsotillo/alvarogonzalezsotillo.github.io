#+TITLE:       Listado de fotos de Ra칤ces
#+AUTHOR:      츼lvaro Gonz치lez Sotillo
#+EMAIL:       alvarogonzalezsotillo@gmail.com
#+DATE:        2021-11-04
#+URI:         /blog/listado-en-raices
#+KEYWORDS:    javascript, raices
#+TAGS:        javascript, raices
#+LANGUAGE:    es
#+OPTIONS:     H:3 num:t \n:nil ::t |:t ^:nil -:nil f:t *:t <:t
#+options:     num:nil
#+DESCRIPTION:  El proyecto Raices es la herramienta de gesti칩n integrada de centros educativos de la Comunidad de Madrid. En la versi칩n actual, no permite crear una p치gina imprimible con las fotograf칤as y nombres de todos los alumnos de un grupo.



* El problema
 El proyecto Raices es la herramienta de gesti칩n integrada de centros educativos de la Comunidad de Madrid.  En la versi칩n actual, no permite crear una p치gina imprimible con las fotograf칤as y nombres de todos los alumnos de un grupo.

* La soluci칩n
A partir de la pantalla de *Faltas a d칤a completo en una unidad en un periodo* se puede generar una p치gina imprimible:

#+caption: Men칰 de Raices que muestra la p치gina requerida
[[file:menu-raices.png]]  
  
- En Firefox o Chrome, pulsar las teclas =CONTROL+MAY칔SCULAS+B=, hasta que se muestre la barra de marcadores (/bookmarks/).
- Despu칠s, arrastrar el recuadro de m치s abajo a la barra de marcadores
#+html: <center><a href="javascript:%28function%28%29%7B%0A%20%20%20%20try%7B%0A%20%20%20%20%20%20%20%20const%20inferior%20%3D%20window.frames%5B%27inferior%27%5D%3B%0A%0A%20%20%20%20%20%20%20%20const%20principal%20%3D%20inferior.window.frames%5B%27principal%27%5D%3B%0A%0A%20%20%20%20%20%20%20%20const%20cuerpo%20%3D%20principal.window.frames%5B%27cuerpo%27%5D%3B%0A%0A%20%20%20%20%20%20%20%20const%20images%20%3D%20cuerpo.document.querySelectorAll%28%27table.TableData%20%3E%20tbody%20%3E%20tr%20%3E%20td%20%3E%20img%27%29%3B%0A%20%20%20%20%20%20%20%20const%20names%20%3D%20cuerpo.document.querySelectorAll%28%20%27table.TableData%20%3E%20tbody%20%3E%20tr%20%3E%20td%20%3E%20a%27%29%3B%0A%20%20%20%20%20%20%20%20const%20ciclo%20%3D%20cuerpo.document.querySelectorAll%28%27select%5Bname%3DX_OFERTAMATRIC%5D%20%3E%20option%5Bselected%5D%27%29%5B0%5D%3B%0A%20%20%20%20%20%20%20%20const%20title%20%3D%20ciclo.title%3B%0A%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20const%20newWindow%20%3D%20window.open%28%29%3B%0A%20%20%20%20%20%20%20%20const%20newDocument%20%3D%20newWindow.document%3B%0A%0A%20%20%20%20%20%20%20%20const%20header%20%3D%20%27%3Chead%3E%3Ctitle%3E%27%20%2B%20ciclo.title%20%2B%20%27%3C%2Ftitle%3E%27%20%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%27%3Cstyle%3Ebody%7Btext-align%3A%20center%3B%7D%27%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%27titulo%7Bfont-size%3A%2020px%3Btext-align%3A%20center%3B%7D%27%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%27img%7Bmin-width%3A%2070px%3Bmax-width%3A%2070px%3B%7D%27%20%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%27td%7Btext-align%3A%20center%3Bfont-size%3A%2012px%3B%7D%27%20%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%27%3C%2Fstyle%3E%3C%2Fhead%3E%27%3B%0A%0A%20%20%20%20%20%20%20%20newDocument.writeln%28header%29%3B%0A%20%20%20%20%20%20%20%20newDocument.writeln%28%60%3Cbody%3E%60%29%3B%0A%20%20%20%20%20%20%20%20newDocument.writeln%28%60%3Ctitulo%3E%24%7Bciclo.title%7D%3C%2Ftitulo%3E%60%29%3B%0A%20%20%20%20%20%20%20%20newDocument.writeln%28%27%3Ctable%3E%27%29%3B%0A%0A%20%20%20%20%20%20%20%20let%20column%20%3D%200%3B%0A%20%20%20%20%20%20%20%20const%20maxColumns%20%3D%205%3B%0A%20%20%20%20%20%20%20%20for%28%20let%20i%20%3D%200%20%3B%20i%20%3C%20images.length%20%3B%20i%2B%2B%20%29%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20image%20%3D%20images%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20name%20%3D%20names%5Bi%5D%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%28%20column%20%3D%3D%200%20%29%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20newDocument.writeln%28%27%3Ctr%3E%27%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20html%20%3D%20%27%3Ctd%3E%3Cimg%20src%3D%5C%27%27%2Bimage.src%2B%27%5C%27%3E%3Cbr%3E%27%2Bname.innerText%2B%27%3C%2Ftd%3E%27%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20newDocument.writeln%28html%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20column%20%2B%3D%201%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%28%20column%20%3D%3D%205%20%29%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20newDocument.writeln%28%27%3Ctr%3E%27%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20column%20%3D%200%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20newDocument.writeln%28%27%3C%2Ftable%3E%27%29%3B%0A%20%20%20%20%20%20%20%20newDocument.writeln%28%27%3C%2Fbody%3E%27%29%3B%0A%20%20%20%20%20%20%20%20window.setTimeout%28%20newWindow.print.bind%28newWindow%29%2C%202000%20%29%3B%0A%0A%20%20%20%20%7D%0A%20%20%20%20catch%28error%29%7B%0A%20%20%20%20%20%20%20%20console.log%28error%29%3B%0A%20%20%20%20%20%20%20%20alert%28%0A%20%20%20%20%20%20%20%20%20%20%20%20%60Solo%20funciona%20en%20las%20p%C3%A1ginas%20de%3A%5Cn%20%20%27Faltas%20a%20d%C3%ADa%20completo%20en%20una%20unidad%20en%20un%20periodo%27%5Cn%20%20%27Faltas%20de%20asistencia%20de%20una%20unidad%20en%20una%20fecha%27%5Cn%5CnTambi%C3%A9n%20podr%C3%ADa%20ser%20que%20la%20versi%C3%B3n%20de%20raices%20es%20incompatible.%20Versiones%20nuevas%20en%20alvaro.gonzalezsotillo%40educa.madrid.org%60%0A%20%20%20%20%20%20%20%20%29%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%7D%29%28%29%3B%0A" style="border-style:solid;background-color:yellow;">P치gina de fotograf칤as de grupo</a></center>
- Cuando se est칠 visualizando el listado de  *Faltas a d칤a completo en una unidad en un periodo*, pulsar el bot칩n creado usando el men칰 de /bookmarks/

#+caption: Invocar el /bookmark/ desde el men칰 en Firefox  
[[file:menu-bookmarks.png]]
* Explicaci칩n t칠cnica
Se puede acceder mediante javascript a la estructura de una p치gina web cargada en el navegador, y copiarla en una nueva p치gina. Puede ser un problema futuro si Raices cambia de versi칩n y modifica la estructura de sus p치ginas.

La ejecuci칩n del programa javascript se hace mediante un [[https://www.freecodecamp.org/news/what-are-bookmarklets/][bookmarklet]], que es un marcador que en vez de enviar el navegador a una p치gina, ejecuta un programa sobre la p치gina ya cargada.

El programa que se ejecuta es el siguiente. Se puede observar que, en 2021, la Comunidad de Madrid a칰n usa =framesets= 游땻
#+begin_src javascript
(function(){
    try{
        const inferior = window.frames['inferior'];

        const principal = inferior.window.frames['principal'];

        const cuerpo = principal.window.frames['cuerpo'];

        const images = cuerpo.document.querySelectorAll('table.TableData > tbody > tr > td > img');
        const names = cuerpo.document.querySelectorAll( 'table.TableData > tbody > tr > td > a');
        const ciclo = cuerpo.document.querySelectorAll('select[name=X_OFERTAMATRIC] > option[selected]')[0];
        const title = ciclo.title;

        
        const newWindow = window.open();
        const newDocument = newWindow.document;

        const header = '<head><title>' + ciclo.title + '</title>' +
             '<style>body{text-align: center;}'+
                    'titulo{font-size: 20px;text-align: center;}'+
                    'img{min-width: 70px;max-width: 70px;}' +
                    'td{text-align: center;font-size: 12px;}' +
             '</style></head>';

        newDocument.writeln(header);
        newDocument.writeln(`<body>`);
        newDocument.writeln(`<titulo>${ciclo.title}</titulo>`);
        newDocument.writeln('<table>');

        let column = 0;
        const maxColumns = 5;
        for( let i = 0 ; i < images.length ; i++ ){
            const image = images[i];
            const name = names[i];

            if( column == 0 ){
                newDocument.writeln('<tr>');
            }
            
            const html = '<td><img src=\''+image.src+'\'><br>'+name.innerText+'</td>';
            newDocument.writeln(html);
            column += 1;

            if( column == 5 ){
                newDocument.writeln('<tr>');
                column = 0;
            }
            
        }
        newDocument.writeln('</table>');
        newDocument.writeln('</body>');
        window.setTimeout( newWindow.print.bind(newWindow), 2000 );

    }
    catch(error){
        console.log(error);
        alert(
            `Solo funciona en las p치ginas de:\n  'Faltas a d칤a completo en una unidad en un periodo'\n  'Faltas de asistencia de una unidad en una fecha'\n\nTambi칠n podr칤a ser que la versi칩n de raices es incompatible. Versiones nuevas en alvaro.gonzalezsotillo@educa.madrid.org`
        );
    }
    
})();
#+end_src

Para convertirlo en una sola l칤nea, y poder crear el bot칩n de m치s arriba, hay que convertir en /script/ en una URL de javascript. Utilizo la funci칩n de emacs =urlenc:encode-region=

* Actualizaci칩n 2022-09-21
Este a침o no soy tutor de ning칰n grupo, y parece que cuando no se es tutor cambian las p치ginas mostradas para las faltas. Este c칩digo funciona para no tutores:

#+html: <center><a href="javascript:%28function%28%29%7B%0A%20%20%20%20try%7B%0A%20%20%20%20%20%20%20%20let%20inferior%20%3D%20window.frames%5B%27inferior%27%5D%3B%0A%0A%20%20%20%20%20%20%20%20let%20principal%20%3D%20inferior.window.frames%5B%27principal%27%5D%3B%0A%0A%20%20%20%20%20%20%20%20let%20cuerpo%20%3D%20principal.window.frames%5B%27cuerpo%27%5D%3B%0A%0A%20%20%20%20%20%20%20%20let%20images%20%3D%20cuerpo.document.querySelectorAll%28%27td.celdaTablaFormFila%20%20img.imagenBordeVerde%27%29%3B%0A%20%20%20%20%20%20%20%20let%20names%20%3D%20cuerpo.document.querySelectorAll%28%20%27td.celdaTablaFormExt%20td.celdaTablaFormInt%20td.celdaTablaFormFila%20%3E%20table%20%3E%20tbody%20%3E%20tr%3Anth-child%282%29%20%3E%20td%5Balign%3DCENTER%5D%27%29%3B%0A%20%20%20%20%20%20%20%20let%20ciclo%20%3D%20cuerpo.document.querySelectorAll%28%27td%5Bclass%3DceldaFormTitulo%5D%27%29%5B0%5D%3B%0A%20%20%20%20%20%20%20%20let%20title%20%3D%20ciclo.innerHTML.split%28%27%2F%27%29%5B1%5D%3B%0A%0A%20%20%20%20%20%20%20%20console.log%28names%29%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20let%20newWindow%20%3D%20window.open%28%29%3B%0A%20%20%20%20%20%20%20%20let%20newDocument%20%3D%20newWindow.document%3B%0A%0A%20%20%20%20%20%20%20%20let%20header%20%3D%20%27%3Chead%3E%3Ctitle%3E%27%20%2B%20title%20%2B%20%27%3C%2Ftitle%3E%27%20%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%27%3Cstyle%3Ebody%7Btext-align%3A%20center%3B%7D%27%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%27titulo%7Bfont-size%3A%2020px%3Btext-align%3A%20center%3B%7D%27%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%27img%7Bmin-width%3A%2070px%3Bmax-width%3A%2070px%3B%7D%27%20%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%27td%7Btext-align%3A%20center%3Bfont-size%3A%2012px%3B%7D%27%20%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%27%3C%2Fstyle%3E%3C%2Fhead%3E%27%3B%0A%0A%20%20%20%20%20%20%20%20newDocument.writeln%28header%29%3B%0A%20%20%20%20%20%20%20%20newDocument.writeln%28%60%3Cbody%3E%60%29%3B%0A%20%20%20%20%20%20%20%20newDocument.writeln%28%60%3Ctitulo%3E%24%7Btitle%7D%3C%2Ftitulo%3E%60%29%3B%0A%20%20%20%20%20%20%20%20newDocument.writeln%28%27%3Ctable%3E%27%29%3B%0A%0A%20%20%20%20%20%20%20%20let%20column%20%3D%200%3B%0A%20%20%20%20%20%20%20%20const%20maxColumns%20%3D%205%3B%0A%20%20%20%20%20%20%20%20for%28%20let%20i%20%3D%200%20%3B%20i%20%3C%20images.length%20%3B%20i%2B%2B%20%29%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20let%20image%20%3D%20images%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20let%20name%20%3D%20names%5Bi%5D%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%28%20column%20%3D%3D%200%20%29%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20newDocument.writeln%28%27%3Ctr%3E%27%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20let%20html%20%3D%20%27%3Ctd%3E%3Cimg%20src%3D%5C%27%27%2Bimage.src%2B%27%5C%27%3E%3Cbr%3E%27%2Bname.innerText%2B%27%3C%2Ftd%3E%27%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20newDocument.writeln%28html%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20column%20%2B%3D%201%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%28%20column%20%3D%3D%205%20%29%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20newDocument.writeln%28%27%3Ctr%3E%27%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20column%20%3D%200%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20newDocument.writeln%28%27%3C%2Ftable%3E%27%29%3B%0A%20%20%20%20%20%20%20%20newDocument.writeln%28%27%3C%2Fbody%3E%27%29%3B%0A%20%20%20%20%20%20%20%20window.setTimeout%28%20%28%29%3D%3E%20newWindow.print%28%29%2C%202000%20%29%3B%0A%0A%20%20%20%20%7D%0A%20%20%20%20catch%28error%29%7B%0A%20%20%20%20%20%20%20%20console.log%28error%29%3B%0A%20%20%20%20%20%20%20%20alert%28%0A%20%20%20%20%20%20%20%20%20%20%20%20%60Solo%20funciona%20en%20las%20p%C3%A1ginas%20de%3A%5Cn%20%20%27Faltas%20de%20asistencia%20en%20una%20fecha%20y%20tramo%27%5Cn%20%20%5CnTambi%C3%A9n%20podr%C3%ADa%20ser%20que%20la%20versi%C3%B3n%20de%20raices%20es%20incompatible.%20Versiones%20nuevas%20en%20alvaro.gonzalezsotillo%40educa.madrid.org%60%0A%20%20%20%20%20%20%20%20%29%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%7D%29%28%29%3B%0A" style="border-style:solid;background-color:yellow;">P치gina de fotograf칤as de grupo</a></center>


#+begin_src javascript


(function(){
    try{
        let inferior = window.frames['inferior'];

        let principal = inferior.window.frames['principal'];

        let cuerpo = principal.window.frames['cuerpo'];

        let images = cuerpo.document.querySelectorAll('td.celdaTablaFormFila  img.imagenBordeVerde');
        let names = cuerpo.document.querySelectorAll( 'td.celdaTablaFormExt td.celdaTablaFormInt td.celdaTablaFormFila > table > tbody > tr:nth-child(2) > td[align=CENTER]');
        let ciclo = cuerpo.document.querySelectorAll('td[class=celdaFormTitulo]')[0];
        let title = ciclo.innerHTML.split('/')[1];

        console.log(names);
        
        let newWindow = window.open();
        let newDocument = newWindow.document;

        let header = '<head><title>' + title + '</title>' +
             '<style>body{text-align: center;}'+
                    'titulo{font-size: 20px;text-align: center;}'+
                    'img{min-width: 70px;max-width: 70px;}' +
                    'td{text-align: center;font-size: 12px;}' +
             '</style></head>';

        newDocument.writeln(header);
        newDocument.writeln(`<body>`);
        newDocument.writeln(`<titulo>${title}</titulo>`);
        newDocument.writeln('<table>');

        let column = 0;
        const maxColumns = 5;
        for( let i = 0 ; i < images.length ; i++ ){
            let image = images[i];
            let name = names[i];

            if( column == 0 ){
                newDocument.writeln('<tr>');
            }
            
            let html = '<td><img src=\''+image.src+'\'><br>'+name.innerText+'</td>';
            newDocument.writeln(html);
            column += 1;

            if( column == 5 ){
                newDocument.writeln('<tr>');
                column = 0;
            }
            
        }
        newDocument.writeln('</table>');
        newDocument.writeln('</body>');
        window.setTimeout( ()=> newWindow.print(), 2000 );

    }
    catch(error){
        console.log(error);
        alert(
            `Solo funciona en las p치ginas de:\n  'Faltas de asistencia en una fecha y tramo'\n  \nTambi칠n podr칤a ser que la versi칩n de raices es incompatible. Versiones nuevas en alvaro.gonzalezsotillo@educa.madrid.org`
        );
    }
    
})();
#+end_src
