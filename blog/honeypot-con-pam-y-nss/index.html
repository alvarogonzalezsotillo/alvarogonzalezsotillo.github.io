<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Honeypot para mi raspberry - 츼lvaro Gonz치lez Sotillo</title>
    <meta charset="utf-8" />
    <meta name="author" content="츼lvaro Gonz치lez Sotillo" />
    <meta name="description" content="Mi raspberry recibe muchos ataques por SSH. En el post investigo sus caracter칤sticas para ver si estoy seguro." />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
    <!-- <link rel="stylesheet" href="/media/css/prettify.css" type="text/css"> -->
  </head>

  <body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">츼lvaro Gonz치lez Sotillo</a></h1>
        <p></p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">Acerca de m칤</a></li>
          <li><a href="https://github.com/alvarogonzalezsotillo">GitHub</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="//www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Buscar">
          <input type="hidden" name="as_sitesearch" value="alvarogonzalezsotillo.github.io">
        </form>
        <img class="avatar" src="/media/img/octaedron.png" />
      </header>
    </div>

<div>
<div class="post">
<h1>Honeypot para mi raspberry</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org0000000">1. tl;dr</a></li>
<li><a href="#org0000004">2. intentos de conexi칩n a mi ssh</a></li>
<li><a href="#org0000015">3. Conseguir las contrase침as</a>
<ul>
<li><a href="#org0000008">3.1. m칩dulo pam</a></li>
<li><a href="#org000000c">3.2. &#x2026; pero el m칩dulo pam no funciona</a></li>
<li><a href="#org000000f">3.3. M칩dulo nss</a></li>
<li><a href="#org0000012">3.4. &#x2026; pero no en mi sistema real</a></li>
</ul>
</li>
<li><a href="#org0000018">4. 쯄e atrevo contra un intruso?</a></li>
</ul>
</div>
</div>
<div id="enlace-blog-outter">
    <a href="https://github.com/alvarogonzalezsotillo/pam-nss-honeypot">쮺칩mo funciona?</a>
</div>

<style>
 #enlace-blog-outter{
     position: fixed;
     left: -9em;
     transform: rotate(45deg);
     padding-bottom: 12em;
     background-color: blueviolet;
     padding-left: 5em;
     padding-right: 5em;
     bottom: -8em;
     padding-top: 1em;
     z-index: 0;
 }

 #enlace-blog-outter a{
     color: white;
 }

 @media (max-width: 600px) {
     /* moviles aqui */
     
     #parametros{
         width: 100%;
     }

     #enlace-blog-outter{
         font-size: 50%;
     }
 }
 </style>
<div id="outline-container-org0000000" class="outline-2">
<h2 id="org0000000"><span class="section-number-2">1.</span> tl;dr</h2>
<div class="outline-text-2" id="text-1">
<p>
He implementado un <a href="https://en.wikipedia.org/wiki/honeypot_(computing)"><i>honeypot</i></a> de ssh dockerizado con un m칩dulo <a href="https://www.redhat.com/sysadmin/pluggable-authentication-modules-pam">pam</a> y un m칩dulo <a href="https://en.wikipedia.org/wiki/name_service_switch">nss</a>. El c칩digo est치 en <a href="https://github.com/alvarogonzalezsotillo/pam-nss-honeypot">https://github.com/alvarogonzalezsotillo/pam-nss-honeypot</a>.
</p>

<p>
Las contrase침as capturadas est치n en <a href="https://github.com/frikismos/passwords-in-honeypot/commits/master">https://github.com/frikismos/passwords-in-honeypot/commits/master</a>
</p>
</div>
</div>
<div id="outline-container-org0000004" class="outline-2">
<h2 id="org0000004"><span class="section-number-2">2.</span> intentos de conexi칩n a mi ssh</h2>
<div class="outline-text-2" id="text-2">
<p>
Tengo instalado un servidor ssh en una raspberry pi. Lo utilizo de nodo basti칩n para acceder a los ordenadores de mi casa.
</p>

<p>
Solo por curiosidad, revis칠 los ficheros de <i>syslog</i> para comprobar c칩mo se localizaban los accesos, tanto correctos como incorrectos. En mi caso, estos registros est치n en el fichero <code>/var/log/auth.log</code>
</p>

<div class="org-src-container">
<pre class="src src-bash">#!/bin/bash
tail -f /var/log/auth.log | grep "failed password"
</pre>
</div>

<p>
Ejecutando el <i>script</i> anterior se pueden ver en tiempo real los intentos fallidos. Depende del momento, pero 춰suele haber varios por minuto!  un enjambre de bots est치n patrullando todo internet buscando servidores ssh, y una vez localizados intentan acceder a ellos.
</p>


<pre class="example" id="org0000003">
mar 21 18:05:56 raspberrypi sshd[15727]: failed password for invalid user root from 61.177.173.31 port 59272 ssh2
mar 21 18:07:56 raspberrypi sshd[15766]: failed password for invalid user root from 179.60.147.143 port 38096 ssh2
mar 21 18:16:01 raspberrypi sshd[15926]: failed password for invalid user sysop from 195.226.194.242 port 35010 ssh2
mar 21 18:18:11 raspberrypi sshd[16039]: failed password for invalid user centos from 179.60.147.143 port 34830 ssh2
mar 21 18:28:22 raspberrypi sshd[16190]: failed password for invalid user default from 179.60.147.143 port 36374 ssh2
mar 21 18:29:49 raspberrypi sshd[16230]: failed password for invalid user admin from 221.165.87.21 port 41166 ssh2
mar 21 18:29:52 raspberrypi sshd[16230]: failed password for invalid user admin from 221.165.87.21 port 41166 ssh2
mar 21 18:33:06 raspberrypi sshd[16277]: failed password for invalid user server from 195.226.194.142 port 29648 ssh2
mar 21 18:38:36 raspberrypi sshd[16339]: failed password for invalid user centos from 179.60.147.143 port 4016 ssh2
mar 21 18:42:27 raspberrypi sshd[16439]: failed password for invalid user root from 61.177.173.31 port 26981 ssh2
mar 21 18:42:30 raspberrypi sshd[16439]: failed password for invalid user root from 61.177.173.31 port 26981 ssh2
mar 21 18:42:33 raspberrypi sshd[16439]: failed password for invalid user root from 61.177.173.31 port 26981 ssh2 
mar 21 18:42:45 raspberrypi sshd[16457]: failed password for invalid user maria from 31.41.244.124 port 28964 ssh2
mar 21 18:43:56 raspberrypi sshd[16467]: failed password for invalid user root from 61.177.173.31 port 22820 ssh2 
mar 21 18:43:59 raspberrypi sshd[16467]: failed password for invalid user root from 61.177.173.31 port 22820 ssh2 
</pre>


<p>
Aunque las trazas de <code>syslog</code> ofrecen bastante informaci칩n, no es posible saber qu칠 contrase침a ha sido utilizada. Esto me parec칤a importante, ya que no estaba seguro de si las contrase침as que se utilizan se <i>parecen</i> a las m칤as. 
</p>
</div>
</div>
<div id="outline-container-org0000015" class="outline-2">
<h2 id="org0000015"><span class="section-number-2">3.</span> Conseguir las contrase침as</h2>
<div class="outline-text-2" id="text-3">
<p>
<code>openssh-server</code> no vuelca las contrase침as incorrectas al <code>log</code> por razones de seguridad (puede ser un usuario leg칤timo con un simple <i>typo</i>). Para conseguir estas contrase침as hab칤a varias opciones
</p>
<ul class="org-ul">
<li>Usar un <i>honeypot</i> de ssh: me parec칤a un problema que los clientes de ssh detectasen que se no se trataba de un servidor ssh real. <a href="https://github.com/desaster/kippo">hay</a> <a href="https://github.com/cowrie/cowrie">multitud</a> <a href="https://github.com/madirish/kojoney2">de</a> <a href="https://github.com/droberson/ssh-honeypot">honeypots</a> <a href="https://github.com/aabed/dockpot">entre</a> <a href="https://github.com/tnich/honssh">los</a> <a href="https://github.com/jaksi/sshesame">que</a> <a href="https://github.com/magisterquis/sshhipot">elegir</a></li>
<li>Compilar <a href="https://metamorphant.de/blog/posts/2021-04-14-ssh-server-opensshd-logging-passwords/">mi propia versi칩n de <code>openssh-server</code></a>: no quer칤a estar pendiente de las actualizaciones de seguridad, volviendo a compilar el servidor</li>
<li>Desarrollar mi propio m칩dulo pam y a침ad칤rselo al servidor ssh. <a href="https://www.redhat.com/sysadmin/pluggable-authentication-modules-pam">pam (pluggable authentication module)</a> es el sistema utilizado por linux para autenticar a los usuarios. Si el c칩digo no era complicado, pod칤a estar razonablemente confiado en no crear problemas de seguridad</li>
</ul>

<p>
La opci칩n m치s evidente para un <i>hobby project</i> es desarrollar algo en <code>c</code>. Aqu칤 hemos venido a jugar 游뱌.
</p>
</div>
<div id="outline-container-org0000008" class="outline-3">
<h3 id="org0000008"><span class="section-number-3">3.1.</span> m칩dulo pam</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Un <a href="https://www.redhat.com/sysadmin/pluggable-authentication-modules-pam">m칩dulo pam</a> es una librer칤a de enlace din치mico (.so) con funciones especiales para autentificar un usuario. La funci칩n m치s interesante ser칤a como la siguiente:
</p>

<div class="org-src-container">
<pre class="src src-c++">pam_extern int pam_sm_authenticate( pam_handle_t *pamh, int flags,int argc, const char **argv ) {
  const char* password = null;
  pam_get_authtok(pamh, pam_authtok, (const char **)&amp;password, null);
  // aqu칤 tengo la contrase침a en la variable password
  log_somewhere(password);
  return pam_perm_denied
}
</pre>
</div>

<p>
Esta funci칩n se llamar치 con la informaci칩n de login del usuario, y devolver치 <code>pam_perm_denied</code> si dicha informaci칩n no permite su autentificaci칩n.
</p>

<p>
Este m칩dulo debe instalarse en el servicio pam correspondiente. La idea es seguir utilizando el resto de la configuraci칩n pam, pero que se deba llamar a este m칩dulo en todas las ocasiones. Seg칰n la documentaci칩n pam, este m칩dulo es <i>suficiente</i>, lo que quiere decir que si no permite el login tampoco lo prohibe, y se consulta al resto de m칩dulos.
</p>

<p>
Esto se consigue a침adiendo la siguiente l칤nea al principio del fichero <code>/etc/pam.d/sshd</code>:
</p>
<pre class="example" id="org0000007">
auth sufficient pam_honeypot.so
</pre>

<p>
La librer칤a <code>pam_honeypot.so</code> debe localizarse en <code>/lib/$multiarch/security</code>. por ejemplo, en un <code>x86_64</code> estar치 en <code>/lib/x86_64-linux-gnu/security</code>. el valor de <code>multiarch</code> se puede conseguir con el comando <code>gcc -print-multiarch</code>.
</p>
</div>
</div>
<div id="outline-container-org000000c" class="outline-3">
<h3 id="org000000c"><span class="section-number-3">3.2.</span> &#x2026; pero el m칩dulo pam no funciona</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Si se instala el m칩dulo pam de la forma descrita, no se consegir치n las contrase침as de todos los intentos de login 驕좶잺. Si el usuario existe en el sistema, se conseguir치 la contrase침a, pero si no existe, la contrase침a ser치 algo parecido a <code>invalid</code>. Adem치s, si se configura sshd para que no permita el usuario <code>root</code>, tampoco se llega a llamar nunca al m칩dulo pam. esto dejar칤a fuera del log de contrase침as a una gran catidad de intentos de login.
</p>

<p>
Me cost칩 un poco encontrar <a href="https://www.linuxquestions.org/questions/programming-9/can%27t-get-auth-token-for-non-local-users-with-pam-module-945164/">la respuesta</a>, pero cuando el sistema detecta que el usuario no existe, oculta la contrase침a al m칩dulo pam (imagino que para no propagar contrase침as de usuarios leg칤timos que se confunden de servidor). Este diagrama explica la relaci칩n entre ssh, nss y pam
</p>

<p>
La soluci칩n es convencer a linux de que todos los usuarios existen, lo que pasa por desarrollar un m칩dulo nss.
</p>




<div id="org000000b" class="figure">
<p><img src="/assets/blog/honeypot-con-pam-y-nss/pam-nss-resumen.png" alt="pam-nss-resumen.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-org000000f" class="outline-3">
<h3 id="org000000f"><span class="section-number-3">3.3.</span> M칩dulo nss</h3>
<div class="outline-text-3" id="text-3-3">
<p>
<a href="https://en.wikipedia.org/wiki/name_service_switch">Name service switch</a> es la forma en que linux configura las bases de datos donde consulta usuarios, grupos de usuarios, nombres de hosts&#x2026; por ejemplo, la forma tradicional de almacenar usuarios es el fichero <code>/etc/passwd</code>. en vez de basar los usuarios directamente en ese fichero, nss puede utilizar el proveedor <code>files</code>, que lee ese fichero. se pueden crear otros proveedores de usuarios, de forma que linux reconozca los usuarios de, por ejemplo, un servicio ldap. todos los proveedores se configuran en el fichero <code>/etc/nsswitch.conf</code>.
</p>

<p>
Un m칩dulo de nss es una librer칤a de enlace din치mico con funciones especiales. En el ejemplo siguiente, cualquier usuario se considera existente, y se le asignan unos valores ficticios a su contrase침a, directorio inicial, <i>shell</i>, <i>uid</i> y <i>gid</i>.
</p>

<div class="org-src-container">
<pre class="src src-c">const char* pw_passwd=;
const char* pw_gecos=;
const char* pw_dir="";
const char* pw_shell="/bin/bash";

enum nss_status _nss_honeypot_getpwnam_r(const char *name, struct passwd *result,
                                         char *buffer, size_t buflen, int *errnop)
{
  result-&gt;pw_name =   name;
  result-&gt;pw_passwd = "contrase침a, posiblemente hasheada";
  result-&gt;pw_gecos =  "nombre real del usuario";
  result-&gt;pw_dir =    "/tmp";
  result-&gt;pw_shell =  "/bin/bash";

  result-&gt;pw_uid = 1000;
  result-&gt;pw_gid = 1000;

  return nss_status_success;
} 
</pre>
</div>

<p>
Una vez compilada la librer칤a e instalada en <code>/lib/$multiarch</code> debe a침adirse al fichero <code>/etc/nsswitch.conf/</code>, de forma que se utilice la base de datos <code>honeypot</code> si no se encuentra el usuario en las bases de datos habituales del sistema:
</p>

<div class="org-src-container">
<pre class="src src-conf">....
passwd:         files honeypot
group:          files
shadow:         files
....
</pre>
</div>

<p>
Las instrucciones concretas de compilaci칩n e instalaci칩n se encuentran en <a href="https://github.com/alvarogonzalezsotillo/pam-nss-honeypot/blob/master/pam-nss-modules/build-install-nss-pam.sh">build-install-nss-pam.sh</a> .
</p>
</div>
</div>
<div id="outline-container-org0000012" class="outline-3">
<h3 id="org0000012"><span class="section-number-3">3.4.</span> &#x2026; pero no en mi sistema real</h3>
<div class="outline-text-3" id="text-3-4">
<p>
Aunque el c칩digo no utiliza memoria din치mica, ni punteros, ni arrays, siempre puede haber alguna vulnerabilidad en alguna parte. Estas librer칤as no deber칤an usarse en un sistema real. Como medida de precauci칩n, he creado un <a href="https://github.com/alvarogonzalezsotillo/pam-nss-honeypot/blob/master/Dockerfile">Dockerfile</a> para ejecutarlo en un entorno algo m치s controlado.
</p>

<p>
En una imagen basada en Debian, instalo las dependencias, compilo e instalo los m칩dulos PAM y NSS, y creo el usuario con UID 1000. Este usuario se corresponde con el UID que el m칩dulo NSS utilizar치 para todos los posibles nombres de usuario, y que acabar치 siendo el UID del usuario de la m치quina host de docker.
</p>

<p>
Detalles en el <i>script</i> <a href="https://github.com/alvarogonzalezsotillo/pam-nss-honeypot/blob/master/build-docker.sh">build-docker.sh</a> y en el <a href="https://github.com/alvarogonzalezsotillo/pam-nss-honeypot/blob/master/Dockerfile">Dockerfile</a>.
</p>
</div>
</div>
</div>
<div id="outline-container-org0000018" class="outline-2">
<h2 id="org0000018"><span class="section-number-2">4.</span> 쯄e atrevo contra un intruso?</h2>
<div class="outline-text-2" id="text-4">
<p>
Este es un <a href="https://www.akamai.com/blog/security/high-interaction-honeypot-versus-low-interaction-honeypot-comparison"><i>honeypot</i> de baja interacci칩n</a>. En un futuro, mi intenci칩n es dejar que el atacante entre en el sistema y monitorizar sus acciones. El sistema deber칤a ser lo m치s real posible, lo que implica que es una actividad arriesgada.
</p>

<p>
Mi plan es separar la red principal de mi casa de la red a la que acceder칤a el intruso, quiz치s mediante un NAT y otras reglas de <i>firewall</i>.
</p>
<ol class="org-ol">
<li>El usuario reconocido por NSSWITCH ser치 siempre el mismo, asociado al UID 10000
<ul class="org-ul">
<li>El UID 10000 se crear치 en el ordenador host de docker, con el mismo nombre</li>
</ul></li>
<li>Tras dejar entrar a un atacante, el m칩dulo PAM dejar치 de autentificar usuarios
<ul class="org-ul">
<li>Con solo un atacante a la vez se podr치 entender mejor qu칠 es lo que hace</li>
</ul></li>
<li>La <i>shell</i> podr칤a ser <a href="https://github.com/Scribery/tlog">tlog</a>.</li>
</ol>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2023-06-08</span>
        <span title="last modification date" class="post-info">2024-12-14</span>
        <span title="tags" class="post-info"><a href="/tags/programaci칩n/">programaci칩n</a>, <a href="/tags/docker/">docker</a>, <a href="/tags/linux/">linux</a></span>
        <span title="author" class="post-info">츼lvaro Gonz치lez Sotillo</span>
      </div>
      <section>
        <!-- <h1>Comments</h1> -->
      </section>
      <!-- <script src="//code.jquery.com/jquery-latest.min.js"></script> -->
      <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script> -->
      <!-- <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>  -->
      <!--<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>-->
      <script src="/media/js/jquery-3.2.1.min.js"></script>
      <script src="/media/js/main.js"></script>
      <script src="/media/js/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/code-prettify/loader/run_prettify.js"></script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 30.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:alvarogonzalezsotillo <at> gmail <dot> com">츼lvaro Gonz치lez Sotillo</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
