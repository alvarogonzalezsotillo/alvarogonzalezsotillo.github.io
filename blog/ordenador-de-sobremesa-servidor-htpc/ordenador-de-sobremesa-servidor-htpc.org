# -*- coding: utf-8-unix; -*-
#+title:       Nuevo HTPC en casa
#+author:      츼lvaro Gonz치lez Sotillo
#+email:       alvarogonzalezsotillo@gmail.com
#+date:        2018-05-17
#+uri:         /blog/ordenador-de-sobremesa-servidor-htpc

#+tags: 
#+description: Acabo de comprarme un asus vc-66. Mi intenci칩n es utilizarlo como servidor accesible desde internet, pero tambi칠n como htpc. Estos son los pasos que he seguido para configurarlo.


#+language:    es
#+options: toc:2

#+attr_html: :align right :style width:10%;max-width:200px;min-width:100px;margin:2em;
[[https://www.asus.com/us/mini-pcs/vivomini-vc66/][file:./asus-vc66.png]]

Acabo de comprarme un [[https://www.asus.com/us/mini-pcs/vivomini-vc66/][asus vc-66]]. Mi intenci칩n es utilizarlo como servidor accesible desde internet, pero tambi칠n como [[https://es.wikipedia.org/wiki/htpc][htpc]]. Estos son los pasos que he seguido para configurarlo.
#+html: <p style="clear:both"></p>

* Instalaci칩n del sistema operativo
El ordenador ven칤a con windows 10 preinstalado. Aunque el /[[https://es.wikipedia.org/wiki/remote_desktop_protocol][remote desktop]]/ es una buena forma de conectarte a un ordenador de tu LAN, no es tan adecuado para un acceso remoto con bajo ancho de banda. En esos casos, una conexi칩n [[https://es.wikipedia.org/wiki/secure_shell][SSH]]/[[https://es.wikipedia.org/wiki/ssh_file_transfer_protocol][FTP]] con la posibilidad de redirigir puertos a [[https://es.wikipedia.org/wiki/vnc][VNC]] me parece m치s adecuada.

De todas formas, Windows sigue instalado, que tampoco es cuesti칩n de despreciar una licencia.

** Haciendo sitio en el disco

1. Particiones del disco duro original
   |---+-----+------+---------+--------------|
   | / | <>  | <>   | <>      | <>           |
   |   | efi | boot | windows | recuperaci칩n |
   |---+-----+------+---------+--------------|
2. Tras reducir partici칩n windows
   |---+-----+------+---------+-------+--------------|
   | / | <>  | <>   | <>      | <>    | <>           |
   |   | efi | boot | windows | libre | recuperaci칩n |
   |---+-----+------+---------+-------+--------------|
3. Tras instalar Ubuntu
   |---+-----+------+---------+-------+--------+------+--------------|
   | / | <>  | <>   | <>      | <>    | <>     | <>   | <>           |
   |   | efi | boot | windows | libre | ubuntu | swap | recuperaci칩n |
   |---+-----+------+---------+-------+--------+------+--------------|
4. Crear partici칩n datos compartidos con windows (formato ntfs)
   |---+-----+------+---------+--------------------------+--------+------+--------------|
   | / | <>  | <>   | <>      | <>                       | <>     | <>   | <>           |
   |   | efi | boot | windows | datos compartidos (ntfs) | ubuntu | swap | recuperaci칩n |
   |---+-----+------+---------+--------------------------+--------+------+--------------|

** Usuarios
He creado un usuario por defecto para la familia con el [[https://help.ubuntu.com/community/autologin][autologin]] activado.

Para compartir ficheros entre los usuarios se utiliza el grupo =discos=, al que pertenecen todos los usuarios
#+begin_src bash
sudo addgroup discos
sudo usermod -a -G discos usuario1
sudo usermod -a -G discos usuario2
#+end_src

Las particiones de datos adicionales (como los datos compartidos con windows) se montan con este grupo    
#+begin_example
# /etc/fstab: static file system information.
#
# use 'blkid' to print the universally unique identifier for a
# device; this may be used with uuid= as a more robust way to name devices
# that works even if disks are added and removed. see fstab(5).
#
# <file system> <mount point>   <type>  <options>       <dump>  <pass>
# / was on /dev/sda7 during installation
uuid=04c0c550-c5c3-4ab5-b0f2-02d071836091 /               ext4    errors=remount-ro 0       1
# /boot/efi was on /dev/sda1 during installation
uuid=0e07-e3eb  /boot/efi       vfat    umask=0077      0       1
# swap was on /dev/sda8 during installation
uuid=7fa25a22-5511-47c7-9ae8-34d96d23d41d none            swap    sw              0       0

# ntfs compartido con windows
uuid=9e1cf2601cf2333f /datos/datos-compartidos-200m ntfs gid=discos,dmask=002,fmask=113 0 2
#+end_example

* Home Theater Personal Computer

#+attr_html: :align right :style width:15%;max-width:200px;min-width:100px;margin:1em;
[[https://www.logitech.com/es-es/product/k400-wireless-keyboard-touchpad][file:./wireless-touch-keyboard-k400-plus.png]]

En la parte /hardware/, basta con conectar el ordenador al televisor por el puerto HDMI y utilizar un teclado inal치mbrico. Yo utilizo un [[https://www.logitech.com/es-es/product/k400-wireless-keyboard-touchpad][logitech k400]] que va muy bien, sobre todo por el f치cil acceso a las teclas de volumen (que al final, durante una pel칤cula, es lo que m치s se usa). 

En la parte /software/ he optado por [[HTTPS://KODI.TV/][Kodi]] con el [[https://kodi.wiki/view/add-on:youtube][plugin de Youtube]], aunque al final resulta m치s c칩modo utilizar directamente la web con firefox.

Para /esos/ otros contenidos, utilizo [[HTTPS://TRANSMISSIONBT.COM/][Transmission daemon]]. He seguido los siguientes pasos:
- Instalar con =apt install transmission-daemon=
- Crear un directorio para Transmission en el disco compartido
- Configuraci칩n de Transmission (fichero =settings.json=)
     - Cambiar usuario y contrase침a de acceso remoto
     - Cambiar el directorio por defecto al creado anteriormente
     - Escuchar en la direcci칩n =0.0.0.0=, para permitir conexiones desde fuera del equipo, y eliminar la =whitelist= de equipos con la conexi칩n permitida.
     - Para que el resto de usuarios puedan leer los ficheros bajados por transmission, hay que a침adirlos al grupo =debian-transmission=

#+begin_src bash
sudo usermod -a -G debian-transmission usuario1
sudo usermod -a -G debian-transmission usuario2
#+end_src


Tras instalar transmission, he a침adido el directorio de bajada a los directorios de video de Kodi.

* Acceso remoto
El acceso remoto no es solamente acceder al ordenador desde la lan, sino desde cualquier parte de Internet. los pasos a seguir son los siguientes:

1. Instalar [[https://www.openssh.com/][openssh server]], que nos permitir치 acceder a un terminal y a los ficheros del servidor
   #+begin_src bash
   sudo apt install openssh-server
   #+end_src
2. Redirigir un puerto para acceder a ssh desde internet. para ello
   1. Configurar el ordenador para tener una ip fija
   2. En el router ADSL/fibra, abrir un puerto que se redirija a esa ip fija, al puerto 22 del servidor ssh.

** /Always-on/ vs /wake-on-lan/
Idealmente, el servidor deber칤a estar siempre encendido. en la pr치ctica no siempre es deseable, aunque solo sea por el gasto continuo de 18W.

Para conseguir lo mejor de ambas opciones, puede dejarse al ordenador suspendido (1W) y despertarlo con [[https://es.wikipedia.org/wiki/wake_on_lan][wake-on-lan]] con alguna [[https://play.google.com/store/apps/details?id=com.cbsb.wakelan][aplicaci칩n desde el m칩vil]]. este sistema consiste en enviar un [[https://es.wikipedia.org/wiki/wake_on_lan#paquete_m%25c3%25a1gico][paquete m치gico]] que contiene 16 veces la [[https://es.wikipedia.org/wiki/direcci%25c3%25b3n_mac][MAC]] del equipo a despertar. desde la lan no hay ning칰n problema: el paquete se env칤a a la direcci칩n de broadcast de la red, y el switch lo env칤a a todos los equipos.

Desde Internet es m치s complicado. Se puede intentar abrir un puerto para WoL, pero el router al intentar alcanzar al servidor en la IP interna lanzar치 un [[https://es.wikipedia.org/wiki/protocolo_de_resoluci%25c3%25b3n_de_direcciones][arp]] para conocer su direcci칩n MAC y poder enviar el paquete. Y si el ordenador est치 apagado no responder치, por lo que el paquete m치gico se quedar치 sin enviar.

La soluci칩n es modificar la tabla arp del router, dejando como permanente la direcci칩n ip y mac del servidor.

** Nombre del servidor
La direcci칩n IP asignada a mi router por el ISP es din치mica. Para poder localizar mi servidor en Internet es necesario tener un servicio de [[https://en.wikipedia.org/wiki/dynamic_dns][dynamic dns]]. He elegido a [[https://www.noip.com/][noip.com]] porque:
- Tiene una cuenta gratuita
- Mi router tiene el cliente necesario para actualizar la direcci칩n
- Permite [[https://es.wikipedia.org/wiki/mx_(registro)][registros MX]] para el correo electr칩nico.

* Servidor
En el ordenador he instalado los servicios e-mail y http.

** E-mail
Utilizo [[https://www.exim.org/][exim4]] en una instalaci칩n estandar, con las siguientes configuraciones:
- El /hostname/ del ordenador es el mismo que el del dominio din치mico en noip.
- Utilizo como [[https://wiki.debian.org/gmailandexim4][smarthost una direcci칩n de correo de gmail]]. el resultado es que puedo recibir correos en mi servidor, pero cuando los env칤o parecen todos enviados desde gmail.

A partir de aqu칤, ya puedo utilizar mi direcci칩n [[mailto:spam@alvarogonzalez.no-ip.biz][spam@alvarogonzalez.no-ip.biz]] para registrarme en cualquier sitio 游땙

** Servidor web
El protocolo HTTP es una buena forma de compartir ficheros. He instalado [[https://httpd.apache.org/][apache]] directamente desde el repositorio.


#+begin_example
apt install apache2 
#+end_example

Para no dejar la p치gina por defecto, he instalado un mirror de este blog:

#+begin_example
 documentroot /var/www/alvarogonzalezsotillo.github.io
 <directory /var/www/alvarogonzalezsotillo.github.io>
          options followsymlinks
          allowoverride all
          require all granted
  </directory>
#+end_example

** Owncloud
Para acceder a mis ficheros (fundamentalmente fotograf칤as) utilizo owncloud, instalado desde repositorios:
#+begin_example
apt install mysql-server libapache2-mod-php php-mcrypt php-mysql
apt install owncloud-files
#+end_example

Con esto se consigue un servidor apache capaz de ejecutar owncloud, pero la instalaci칩n de owncloud (en ~/var/www/owncloud~) no es accesible por apache. Es necesario crear un fichero de sitio en ~/etc/apache/sites-available/owncloud.conf~ con el siguiente contenido

#+begin_example
  alias /owncloud /var/www/owncloud

  <directory /var/www/owncloud>
          options followsymlinks
          allowoverride all
          require all granted
  </directory>
#+end_example

Despu칠s, se habilita el sitio con
#+begin_example
a2ensite owncloud
#+end_example

* Configuraci칩n como /workstation/
El servidor tambi칠n deber칤a servirme de /backup/ en el caso de que no tenga disponible mi port치til. lA siguiente configuraci칩n es la que utilizo para mi trabajo diario.

** Zsh
Zsh es una shell que puede sustituir a bash de forma casi transparente. Las razones por las que utilizo zsh son
- Mejor autocomplecci칩n con tabulador, tanto para ficheros como para opciones de comandos
- El historial de comandos se comparte entre todas las sesiones abiertas
- El historial de comandos se filtra por el comando parcial ya tecleado
- Se puede utilizar ~**~ para hacer /globbing/ de directorios.
- Los /plugins/ y temas de [[https://github.com/robbyrussell/oh-my-zsh][ohmyzsh]] /"will not make you a 10x developer...but you might feel like one"/. Utilizo los plugis para =emacs=, =tmux=, =git= y =gradlew=, y el tema =robbyrussell=

** Emacs
Cuando tienes un martillo, todo te parecen clavos. [[HTTPS://WWW.GNU.ORG/SOFTWARE/EMACS/][Emacs]] es el martillo m치s grande que he usado nunca.

En un servidor, tiene la gran ventaja de que puede trabajarse directamente en una sesi칩n de ssh, sin entorno gr치fico. Emacs y tmux son una combinaci칩n ganadora en estos casos.

En mi port치til he compilado emacs a partir de los fuentes, pero en el servidor bastar치 con utilizar un repositorio PPA:

   #+begin_src bash
   sudo add-apt-repository ppa:kelleyk/emacs
   sudo apt update
   sudo apt install emacs25
   #+end_src

La mejor parte de Emacs es la configuraci칩n que cada usuario realiza con 칠l. La m칤a est치 en un repositorio git

   #+begin_src bash
   cd
   git clone https://alvarogonzalezsotillo@github.com/alvarogonzalezsotillo/.emacs.d.git
   #+end_src

Al arrancar Emacs, autom치ticamente descargar치 [[https://github.com/alvarogonzalezsotillo/.emacs.d/blob/master/my/my-packages.el][mis paquetes]] y activar치 mi configuraci칩n.

** Materiales para clase
Como cuento en [[../../../../blog/mi-publicacion-de-materiales-para-clase][otra entrada]], utilizo b치sicamente Latex y org-mode para mis clases.

La instalaci칩n de Latex, y los paquetes que utilizo, se consigue f치cilmente con:

  #+begin_src sh 
  sudo apt-get install texlive-collection-binextra \
  texlive-latex-recommended \
  texlive-extra-utils \
  texlive-collection-langspanish \
  texlive-collection-latex \
  texlive-collection-latexextra \
  #+end_src

Adem치s, utilizo otras herramientas como [[https://inkscape.org/en/][Inkscape]] y [[https://www.graphviz.org/][Graphviz]] que tambi칠n instalo con =apt-get=

** Ofim치tica
Aunque pr치cticamente ya no lo uso, de vez en cuando alguien de la familia necesita utiliza Microsoft Office. Para eso mantengo un prefijo de [[https://www.winehq.org/][Wine]] que copio de ordenador en ordenador, con la suite ofim치tica ya instalada.


