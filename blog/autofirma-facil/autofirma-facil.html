<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es">
<head>
<!-- 2024-04-27 sáb 17:56 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Autofirma fácil en Windows usando la línea de comandos</title>
<meta name="author" content="Álvaro González Sotillo" />
<meta name="description" content="Se puede automatizar la firma repetitiva de documentos con la interfaz de línea de comandos de Autofirma" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Autofirma fácil en Windows usando la línea de comandos</h1>

<div id="outline-container-org0000000" class="outline-2">
<h2 id="org0000000"><span class="section-number-2">1.</span> TL;DR</h2>
<div class="outline-text-2" id="text-1">
<p>
Se puede automatizar la firma repetitiva de documentos con la interfaz de línea de comandos de Autofirma. A partir del <a href="https://administracionelectronica.gob.es/ctt/resources/Soluciones/138/Descargas/MCF-manual-integrador-ES-1-8-2.pdf?idIniciativa=138&amp;idElemento=26033&amp;idioma=es">manual para el integrador</a> he desarrollado este <a href="Firmar con Autofirma.cmd"><i>script</i> de CMD para Windows</a> que, copiado en la carpeta <i>[[<a href="https://devblogs.microsoft.com/oldnewthing/20170403-00">https://devblogs.microsoft.com/oldnewthing/20170403-00</a></i>?p=95885][Send to]]/, permite firmar varios documentos seleccionándolos en el <i>explorer</i> y usando el menú contextual.
</p>
</div>
</div>

<div id="outline-container-org0000003" class="outline-2">
<h2 id="org0000003"><span class="section-number-2">2.</span> Explicación del <i>script</i></h2>
<div class="outline-text-2" id="text-2">
<p>
El uso de medios electrónicos tiene el efecto paradójico de aumentar la cantidad de burocracia, en vez de disminuirla. Algunos responsables institucionales consideran que, al utilizar tramitación electrónica, todo se vuelve automáticamente fácil, sin darse cuenta que muchos trámites se vuelven más engorrosos al utilizar el ordenador. Por ejemplo, es mucho más fácil firmar decenas de documentos que lleguen por correo ordinario, que firmar decenas de ficheros PDF que lleguen por email.
</p>

<p>
Partiendo del ejemplo para <i>bash</i> en <a href="https://github.com/ctt-gob-es/clienteafirma/issues/20#issuecomment-791816087">https://github.com/ctt-gob-es/clienteafirma/issues/20#issuecomment-791816087</a>, desarrollé un <i>script</i> CMD que recorre todos los ficheros pasados como parámetro. Con este <i>script</i> en la carpeta <i>[[<a href="https://devblogs.microsoft.com/oldnewthing/20170403-00">https://devblogs.microsoft.com/oldnewthing/20170403-00</a></i>?p=95885][Send to]]/ de Windows, basta con seleccionar varios ficheros en el <i>explorer</i> y utilizar el botón derecho para obtener una copia firmada de cada uno.
</p>

<p>
La parte central del <i>script</i> es la siguiente
</p>

<div class="org-src-container">
<pre class="src src-bat"><span style="color: #729fcf;">set</span> <span style="color: #ff6347;">DNI</span>=12345678
<span style="color: #729fcf;">set</span> <span style="color: #ff6347;">ARCHIVO</span>=%~dpF1
<span style="color: #729fcf;">set</span> <span style="color: #ff6347;">ARCHIVOSINEXTENSION</span>=%~dpn1
autofirmacommandline sign -<span style="color: #8ae234; font-weight: bold;">i</span> <span style="color: #ad7fa8; font-style: italic;">"%ARCHIVO%"</span> -<span style="color: #8ae234; font-weight: bold;">o</span> <span style="color: #ad7fa8; font-style: italic;">"%ARCHIVOSINEXTENSION% - firmado.pdf"</span> -<span style="color: #8ae234; font-weight: bold;">config</span> <span style="color: #ad7fa8; font-style: italic;">"%CONFIG%"</span> -<span style="color: #8ae234; font-weight: bold;">filter</span> subject.contains:%<span style="color: #ff6347;">DNI</span>%;nonexpired:
</pre>
</div>

<p>
Estas opciones están documentadas en el <a href="https://administracionelectronica.gob.es/ctt/resources/Soluciones/138/Descargas/MCF-manual-integrador-ES-1-8-2.pdf?idIniciativa=138&amp;idElemento=26033&amp;idioma=es">manual para el integrador</a> de Autofirma:
</p>
<ul class="org-ul">
<li><code>-i</code>: Fichero a firmar.</li>
<li><code>-o</code>: Fichero firmado.</li>
<li><code>-config</code>: Cadena con la configuración de la firma, explicada más adelante.</li>
<li><code>-filter</code>: Preselección de certificados con los que firmar. Si el filtro solo deja un certificado disponible, Autofirma no mostrará ninguna GUI, y firmará el fichero directamente.</li>
</ul>

<p>
El parámetro <code>-config</code> es una cadena con parejas de clave-valor, separadas con la cadena <code>\n</code>. Uso las siguientes opciones:
</p>
<ul class="org-ul">
<li><code>headless=true</code>: Para asegurar que Autofirma no muestre ninguna GUI.</li>
<li><code>layer2Text</code>: Texto visible de la firma. Se pueden utilizar algunos <i>placeholder</i> que Autofirma sustuirá por los valores concretos que dependen del certificado.</li>
<li><code>signaturePositionOnPageXXXXX</code>: varios valores para indicar el rectángulo de la página donde se incrustará la firma.</li>
<li><code>signaturePage</code>: número de página del documento donde firmar.</li>
<li><code>signatureRubricImage</code>: imagen a incluir como firma visible. Debe ser un fichero JPG en base64. En mis pruebas, la firma no aparecía si el fichero demasiado grande, estando el límite en 6KB aproximadamente</li>
</ul>

<p>
Para construir el parámetro <code>-config</code> utilizo varias variables intermedias, de forma que sea algo más cómodo:  
</p>
<div class="org-src-container">
<pre class="src src-bat"><span style="color: #729fcf;">SET</span> <span style="color: #ff6347;">PositionOnPageLowerLeftX</span>=50  
<span style="color: #729fcf;">SET</span> <span style="color: #ff6347;">PositionOnPageLowerLeftY</span>=135   
<span style="color: #729fcf;">SET</span> <span style="color: #ff6347;">PositionOnPageUpperRightX</span>=250 
<span style="color: #729fcf;">SET</span> <span style="color: #ff6347;">PositionOnPageUpperRightY</span>=245 
<span style="color: #729fcf;">SET</span> <span style="color: #ff6347;">l2FontColor</span>=black             
<span style="color: #729fcf;">SET</span> <span style="color: #ff6347;">l2FontSize</span>=7                  
<span style="color: #729fcf;">SET</span> <span style="color: #ff6347;">l2FontFamily</span>=1                
<span style="color: #729fcf;">SET</span> <span style="color: #ff6347;">l2FontStyle</span>=0                 
<span style="color: #729fcf;">SET</span> <span style="color: #ff6347;">LAYER2TEXT</span>=Firmado por $$GIVENNAME$$ $$SURNAME$$ el $$SIGNDATE=dd/MM/YYYY$$ con un certificado emitido por $$ISSUERCN$$ con n&#250;mero de serie $$CERTSERIAL$$
<span style="color: #729fcf;">SET</span> <span style="color: #ff6347;">IMAGEN</span>=/<span style="color: #8ae234; font-weight: bold;">9j</span>/4AAQSkZJRgABAQEAYABgAAD/4gJcSUNDX1BST0Z.........
<span style="color: #729fcf;">SET</span> <span style="color: #ff6347;">signaturePage</span>=1

<span style="color: #729fcf;">SET</span> <span style="color: #ff6347;">CONFIG</span>=headless=true\n layer2Text=%<span style="color: #ff6347;">LAYER2TEXT</span>%\n    signaturePositionOnPageLowerLeftX=%<span style="color: #ff6347;">PositionOnPageLowerLeftX</span>%\n    signaturePositionOnPageLowerLeftY=%<span style="color: #ff6347;">PositionOnPageLowerLeftY</span>%\n    signaturePositionOnPageUpperRightX=%<span style="color: #ff6347;">PositionOnPageUpperRightX</span>%\n    signaturePositionOnPageUpperRightY=%<span style="color: #ff6347;">PositionOnPageUpperRightY</span>%\n    layer2FontColor=%<span style="color: #ff6347;">l2FontColor</span>%\n    layer2FontSize=%<span style="color: #ff6347;">l2FontSize</span>%\n    layer2FontFamily=%<span style="color: #ff6347;">l2FontFamily</span>%\n    layer2FontStyle=%<span style="color: #ff6347;">l2FontStyle</span>%\n       signaturePage=%<span style="color: #ff6347;">signaturePage</span>% \n signatureRubricImage=%<span style="color: #ff6347;">IMAGEN</span>%
</pre>
</div>


<p>
Se puede 
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Fecha: 2024-04-27</p>
<p class="author">Autor: Álvaro González Sotillo</p>
<p class="date">Created: 2024-04-27 sáb 17:56</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>