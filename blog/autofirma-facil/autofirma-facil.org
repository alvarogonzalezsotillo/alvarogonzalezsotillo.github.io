#+title: Autofirma f치cil en Windows usando la l칤nea de comando y la carpeta send to

#+AUTHOR:      츼lvaro Gonz치lez Sotillo
#+EMAIL:       alvarogonzalezsotillo@gmail.com
#+DATE:        2024-04-27
#+URI:         /blog/autofirma-facil

#+TAGS: windows, autofirma
#+DESCRIPTION: Se puede automatizar la firma repetitiva de documentos con la interfaz de l칤nea de comando de Autofirma


#+LANGUAGE: es
#+options: toc:nil

* TL;DR
Se puede automatizar la firma repetitiva de documentos con la interfaz de l칤nea de comandos de Autofirma. A partir del [[https://administracionelectronica.gob.es/ctt/resources/Soluciones/138/Descargas/MCF-manual-integrador-ES-1-8-2.pdf?idIniciativa=138&idElemento=26033&idioma=es][manual para el integrador]] he desarrollado este [[file:Firmar con Autofirma.cmd][/script/ de CMD para Windows]] que, copiado en la carpeta [[https://devblogs.microsoft.com/oldnewthing/20170403-00/?p=95885][/Send to/]], permite firmar varios documentos seleccion치ndolos en el /explorer/ y usando el men칰 contextual.

* Explicaci칩n del /script/

El uso de medios electr칩nicos tiene el efecto parad칩jico de aumentar la cantidad de burocracia, en vez de disminuirla. Algunos responsables institucionales consideran que, al utilizar tramitaci칩n electr칩nica, todo se vuelve autom치ticamente f치cil, sin darse cuenta que muchos tr치mites se vuelven m치s engorrosos al utilizar el ordenador. Por ejemplo, es mucho m치s f치cil firmar decenas de documentos que lleguen por correo ordinario, que firmar decenas de ficheros PDF que lleguen por email.

Partiendo del ejemplo para /bash/ en https://github.com/ctt-gob-es/clienteafirma/issues/20#issuecomment-791816087, desarroll칠 un /script/ CMD que recorre todos los ficheros pasados como par치metro. Con este /script/ en la carpeta [[https://devblogs.microsoft.com/oldnewthing/20170403-00/?p=95885][/Send to/]] de Windows, basta con seleccionar varios ficheros en el /explorer/ y utilizar el bot칩n derecho para obtener una copia firmada de cada uno.

La parte central del /script/ es la siguiente

#+begin_src bat
set DNI=12345678
set ARCHIVO=%~dpF1
set ARCHIVOSINEXTENSION=%~dpn1
autofirmacommandline sign -i "%ARCHIVO%" -o "%ARCHIVOSINEXTENSION% - firmado.pdf" -config "%CONFIG%" -filter subject.contains:%DNI%;nonexpired:
#+end_src

Estas opciones est치n documentadas en el [[https://administracionelectronica.gob.es/ctt/resources/Soluciones/138/Descargas/MCF-manual-integrador-ES-1-8-2.pdf?idIniciativa=138&idElemento=26033&idioma=es][manual para el integrador]] de Autofirma:
- =-i=: Fichero a firmar.
- =-o=: Fichero firmado.
- =-config=: Cadena con la configuraci칩n de la firma, explicada m치s adelante.
- =-filter=: Preselecci칩n de certificados con los que firmar. Si el filtro solo deja un certificado disponible, Autofirma no mostrar치 ninguna GUI, y firmar치 el fichero directamente.

El par치metro =-config= es una cadena con parejas de clave-valor, separadas con la cadena =\n=. Uso las siguientes opciones:
- =headless=true=: Para asegurar que Autofirma no muestre ninguna GUI.
- =layer2Text=: Texto visible de la firma. Se pueden utilizar algunos /placeholder/ que Autofirma sustuir치 por los valores concretos que dependen del certificado.
- =signaturePositionOnPageXXXXX=: varios valores para indicar el rect치ngulo de la p치gina donde se incrustar치 la firma.
- =signaturePage=: n칰mero de p치gina del documento donde firmar.
- =signatureRubricImage=: imagen a incluir como firma visible. Debe ser un fichero JPG en base64. En mis pruebas, la firma no aparec칤a si el fichero demasiado grande, estando el l칤mite en 6KB aproximadamente

Para construir el par치metro =-config= utilizo varias variables intermedias, de forma que sea algo m치s c칩modo:  
#+begin_src bat
SET PositionOnPageLowerLeftX=50  
SET PositionOnPageLowerLeftY=135   
SET PositionOnPageUpperRightX=250 
SET PositionOnPageUpperRightY=245 
SET l2FontColor=black             
SET l2FontSize=7                  
SET l2FontFamily=1                
SET l2FontStyle=0                 
SET LAYER2TEXT=Firmado por $$GIVENNAME$$ $$SURNAME$$ el $$SIGNDATE=dd/MM/YYYY$$ con un certificado emitido por $$ISSUERCN$$ con n칰mero de serie $$CERTSERIAL$$
SET IMAGEN=/9j/4AAQSkZJRgABAQEAYABgAAD/4gJcSUNDX1BST0Z.........
SET signaturePage=1

SET CONFIG=headless=true\n layer2Text=%LAYER2TEXT%\n    signaturePositionOnPageLowerLeftX=%PositionOnPageLowerLeftX%\n    signaturePositionOnPageLowerLeftY=%PositionOnPageLowerLeftY%\n    signaturePositionOnPageUpperRightX=%PositionOnPageUpperRightX%\n    signaturePositionOnPageUpperRightY=%PositionOnPageUpperRightY%\n    layer2FontColor=%l2FontColor%\n    layer2FontSize=%l2FontSize%\n    layer2FontFamily=%l2FontFamily%\n    layer2FontStyle=%l2FontStyle%\n       signaturePage=%signaturePage% \n signatureRubricImage=%IMAGEN%
#+end_src  


* Qu칠 piensan los LLM de este asunto, antes de que publique este art칤culo

Como experimento, he pedido a ese LLM del que todos hablan que generase esta 칰ltima parte. Si en un futuro aprende algo de los par치metros anteriores, pensar칠 que ha aprendido gracias a este blog 游땔.

#+begin_example
Quiero un art칤culo para mi blog con este t칤tulo: Autofirma f치cil en Windows usando la l칤nea de comando y la carpeta /send to/.
Aseg칰rate de hablar de la utilidad autofirma de la Sede electr칩nica del Ministerio de Industria y Turismo.
Tambi칠n aseg칰rate de que Autofirma no muestra la interfaz gr치fica, y firma directamente el documento PDF, para ahorrar tiempo.
#+end_example

** Autofirma f치cil en Windows usando la l칤nea de comando y la carpeta /send to/

Firmar documentos digitalmente es una tarea crucial en el mundo actual, donde la seguridad y la eficiencia son fundamentales. La Sede Electr칩nica del Ministerio de Industria y Turismo ofrece una herramienta poderosa llamada Autofirma, dise침ada para simplificar este proceso. En este art칤culo, te mostrar칠 c칩mo aprovechar Autofirma de manera r치pida y sencilla en Windows utilizando la l칤nea de comando y la carpeta "/send to/", lo que te permitir치 agilizar la firma de documentos PDF sin necesidad de abrir la interfaz gr치fica de la aplicaci칩n.

** 쯈u칠 es Autofirma?

Autofirma es una aplicaci칩n proporcionada por la Sede Electr칩nica del Ministerio de Industria y Turismo de Espa침a. Su funci칩n principal es permitir la firma electr칩nica de documentos de forma r치pida y segura. Utiliza certificados digitales para garantizar la autenticidad e integridad de los documentos firmados, lo que los hace legalmente v치lidos.

** Firma f치cil con la l칤nea de comando y la carpeta "/send to/"

Una de las caracter칤sticas m치s 칰tiles de Autofirma es su capacidad para funcionar desde la l칤nea de comando, lo que significa que puedes automatizar el proceso de firma sin necesidad de abrir la interfaz gr치fica de la aplicaci칩n. Adem치s, puedes aprovechar la carpeta "/send to/" de Windows para simplificar a칰n m치s el proceso.

Aqu칤 tienes los pasos para configurar la firma f치cil:

1. **Descargar e instalar Autofirma**: Si a칰n no tienes Autofirma instalado en tu sistema, puedes descargarlo desde la Sede Electr칩nica del Ministerio de Industria y Turismo.

2. **Configurar la l칤nea de comando**: Para usar Autofirma desde la l칤nea de comando, necesitar치s conocer la ubicaci칩n del ejecutable de Autofirma en tu sistema. Por lo general, se encuentra en la carpeta de instalaci칩n de la aplicaci칩n.

3. **Crear un script de firma**: Puedes crear un script por lotes (.bat) que contenga los comandos necesarios para firmar un documento PDF. El comando b치sico suele ser algo as칤:

   #+begin_example
   ruta_al_ejecutable_de_Autofirma -f ruta_al_documento_a_firmar.pdf
   #+end_example

4. **Agregar el script a la carpeta "/send to/"**: Abre el Explorador de Archivos de Windows y navega hasta la carpeta "%APPDATA%\Microsoft\Windows\SendTo". Aqu칤, copia o crea un acceso directo al script de firma que creaste anteriormente.

** Firma de documentos en acci칩n

Una vez que hayas configurado todo, el proceso de firma se vuelve incre칤blemente simple:

1. Selecciona el documento PDF que deseas firmar.

2. Haz clic derecho en el documento y selecciona "Enviar a" > "Autofirma".

3. Autofirma se ejecutar치 en segundo plano y firmar치 el documento autom치ticamente utilizando el certificado digital configurado.

Con estos pasos, has simplificado enormemente el proceso de firma digital en Windows. Ahora puedes firmar documentos con solo unos pocos clics, ahorrando tiempo y esfuerzo.

** Conclusi칩n

Autofirma es una herramienta invaluable para aquellos que necesitan firmar documentos digitalmente de manera r치pida y eficiente. Con la configuraci칩n adecuada, puedes aprovechar su funcionalidad desde la l칤nea de comando y la carpeta "/send to/" para agilizar a칰n m치s el proceso. Espero que esta gu칤a te haya sido 칰til y te permita sacar el m치ximo provecho de Autofirma en tu flujo de trabajo diario. 춰Firma con confianza y seguridad!
